services: docker
language: bash
install:
  - env | sort
  - git clone https://github.com/docker-library/official-images.git ~/official-images
  - docker run -it --rm --name nvchecker --mount type=bind,source=${PWD},target=/data/ -w /data -e NVCHECKER_GITHUB_TOKEN=${GH_TOKEN} snw35/nvchecker:latest nvchecker nvchecker.ini
  - docker run -it --rm --name dfupdate --mount type=bind,source=${PWD},target=/data/ -w /data snw35/dfupdate:latest
  - if [[ $(git status --porcelain | wc -l) -eq 0 ]] && [[ -z ${TRAVIS_TAG} ]]; then
      echo "No local changes detected and no tag set, nothing to build, exiting.";
      travis_terminate 0;
    else
      echo "Local changes or tagged commit detected, continuing...";
    fi

before_script:
  - FFSYNC_VERSION=`grep "ENV FFSYNC_VERSION" Dockerfile | cut -d " " -f 3 | head -n 1`
  - BASE_VERSION=`grep "FROM" Dockerfile | cut -d " " -f 2 | cut -d ":" -f 2`
  - IMAGE="${TRAVIS_REPO_SLUG}:${FFSYNC_VERSION}"
  - PROPOSED_TAG=${FFSYNC_VERSION}-${BASE_VERSION}
  - git config --local user.name "${DOCKER_USERNAME}"
  - git config --local user.email "snw35@use.startmail.com"
  - git remote add upstream https://${GH_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git > /dev/null 2>&1
  - if [ $(git ls-remote --tags upstream "${PROPOSED_TAG}" | wc -l) -eq 0 ]; then
      echo "Propsoed tag does not exist on remote, continuing.";
    else
      echo "Proposed tag already exists on remote, skipping container build.";
      travis_terminate 0;
    fi

script:
  - env | sort
  - travis_retry docker build -t "$IMAGE" .
  - ~/official-images/test/run.sh "$IMAGE" || travis_terminate 1;
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker push "$IMAGE"
  - docker tag "$IMAGE" "${TRAVIS_REPO_SLUG}:latest"
  - docker push "${TRAVIS_REPO_SLUG}:latest"

after_script:
  - docker images

before_deploy:
  - cp new_ver.txt old_ver.txt
  - git checkout master
  - git add -A
  - git commit --message "Software Updated"
  - git tag $PROPOSED_TAG
  - git push --quiet --set-upstream upstream
  - git push --tags --quiet --set-upstream upstream

deploy:
  provider: releases
  api_key: "$GH_TOKEN"
  skip_cleanup: true
  body: 'base image version: $BASE_VERSION
    ffsync version: $FFSYNC_VERSION
    image deployed: $IMAGE'

branches:
  except:
  - "/^untagged/"

env:
  global:
  - secure: gkKZj9lozzOFpC8PPCtNgvyBYyUwgYgQZuY7u1XDwc7WQRgxIobPKslnvIuEuPMEAtHt9r0l0sCRJ2xYwYKdJ9mCFWVKVo8E9nj5H6Be8wjmQNR4pPeAlPMrDi3O34Omf06LlbKVKZd05jlQ23T0tIl3c0rDndCvMdGf4Pu4e9gq8/TETUMi5JjwIVRFGq1TIH+96e6VJjVq2PKui8VqZfE0gTAHsM3Q4R62erXtSp0fa2vwJbSIV91lIKxqVZBd+NfMyafSw2S+mtspCrTHCntWaYm/nQ/cYo7eEbi2iYo8OhvjO/hgB6PHvVvfqt4dfkfqzfWJRg0tVVd5IBqw28HjfQdUfbB2/EDEj95QR8aYhkcNV/6PyOMNdZwHWIQyN4iVjG9ofYbfO4Mc/BSAWAEXBN6IosDQjw8s9+Tu15MLzuSTFo6ms6/Avq0o7hKgnM2vXKTwy1rOIusMVF5XGfvE2D0PPGy+/iemZp/KSvCigo4LWzKq8zClSjUGHqkhHgsNxQ/MHlsJASIGqiNLN+96tom6riXCyYaF8hgtiQTnWF2pbkmF69fj/Xsfebg9HJHZ31rva2yBfyRasswbzaXG37WiaqiOUgqFb0RqyP6PMAYkuu/ysvoDokwIoeBF3sJSzMzMNcaresmXzGqIqRotL4kGvw+OimM/KdV8uFI=
  - secure: fZFP6saG4cscpkVneiK4l33oYCRM5ncD770DCDCh4AiExQOKv5QAu+JYMx9d9VQXPeIma1CN3XAykQxiIrS+wYuTC2CgQaoHzSoKzpbJrM0x1gdolfeGRnFhNP/EAcgns0I7EZPPx0hqGkXec+XA2ciz2lXxT/aTQ7kk6IuVHkX+fKJ/1iKSNpic0Y7v7pXuw30w6MLGFu5UlLBbK7H/P5ZRpB0vshBeN07H+n4xzSLv4wlBR6jI5jZKYftlF8v0lKFziNKKqNqvuiegJSotms1fnMbkVqWXn1glwmRdMkC0Z5lFitJcIlvOKFXYQe+H7wQzJvI+sHFWrD+Az8A8O3k1aQZBJ8KmRZPgFVBQZ+Ow/NJFK5mwTqYduJ0sluK/0gpJKwD5t0QbGoukSKPPmzxf6XtJ5kCU6yk7fOwsnunvzmdY6xPiTdwJuNJrHIjOSO2alV1y8UKKCQV2saLWMatQKQl172byE8ulbK1OYLnMFyXXyzwibc8iqXwYfI+YvUJNkjIgNkfqW5+WCuKAaiVpNrungV9qHG2P5zxXF8Zdu51/vpSutLeof/NNcb0lggnPgltugQIRljSG1rkbNasAVMTtIMoDA6QqTilmL7avJ2nOEoY/Q4DqaO4EapMZ0aztONB/aSwR/rtUqZm1Wpyiddhk+QaGIPZpy805HE8=
  - secure: rKSziyhEKEWMJwEb1DiRPN7N9UpTvX4wpmzGYkrLYyVe4XmL1ULbhruG77mBGC5Yqrupd9+R2tiXWdCLwgTzhD57OCLBl3yep1Mc6DMvoW90nPFfujbkBB6dsWCqoB8jL4KzNBX2tzUzN3KP5Zu+3KTHawUtBlfQFlSnCOQo4Sz5uE6osu6RvJAJW4zS1Ohqgtzg+rKoTEffPOqagR3vR0r9WJh08HNw/eQo8SyeogMu80LxrW9anHz2GqzYSU8Ek930vkbIHx05tXJ/fAYWsEyz19eeiZJmSFWPZYHRBe2KOWTTTxP1k0SBdCSp2FxpmEnC0sutSwS4InnMQ4hsWFrKNwdgTPbi8SFy57Gumg6ovHTfulG+pINTDq2uRU0Ntyd1R4LBP5kanyk34eK3XhJKUqm3wqeDcS1TIfC8NMd0cv8IvGE4arneskvZpsyAJLxm1fRBXTFAYjRjFC72DQsZTUhtEvY8C/LSmyqYCKWc5FypY2QUwyVoriBGaq16TO1aNn75sEK33l3l69uWiA8yMH0g9cQUqF+gG7/wQqgfEmpCSCgH5J//zV/wWyAt6ybCTNkQtBWuJX/r7fzCA0amSO/u4mjmZoBJAMXXA18SB5VXCe86hJ7ESgFe3FImKEgt93UmM8f/lKtEM8t/MvUlKhL8UpjJotNRxrAbgKM=
